
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- HELPER FUNCTIONS ---

    // Check if the user is a Super Admin
    function isSuperAdmin() {
      return request.auth.token.role == 'super_admin';
    }

    // Check if the user is a Tenant Admin for the specific path
    // Matches relative path stored in token: "provinces/..."
    function isTenantAdmin(province, city, barangay) {
      let expectedPath = "provinces/" + province + "/cities/" + city + "/barangays/" + barangay;
      return request.auth.token.role == 'admin' && request.auth.token.tenantPath == expectedPath;
    }
    
    // Check if user is an admin of the tenant specified in the document
    function isTenantAdminOfDoc(docData) {
        return request.auth.token.role == 'admin' && request.auth.token.tenantId == docData.tenantId;
    }

    // --- GLOBAL RULES ---

    // 1. Super Admin: Unlimited Access
    match /{document=**} {
      allow read, write: if isSuperAdmin();
    }

    // 2. Tenant Directory: Public Read (for finding login paths), No Write
    match /tenant_directory/{tenantSlug} {
      allow read: if request.auth != null;
      allow write: if false; // Only Admin SDK can write
    }
    
    // 3. Global User Profiles
    match /users/{userId} {
        // Allow read if:
        // - User is reading their own profile
        // - Super Admin (covered globally)
        // - Tenant Admin reading a user that belongs to their tenant
        allow read: if request.auth != null && (
            request.auth.uid == userId || 
            (request.auth.token.role == 'admin' && resource.data.tenantId == request.auth.token.tenantId)
        );
        
        // Allow list queries if filtering by tenantId matching the admin's tenantId
        allow list: if request.auth != null && 
                     request.auth.token.role == 'admin' && 
                     request.query.limit <= 100 &&
                     resource.data.tenantId == request.auth.token.tenantId;

        allow write: if isSuperAdmin(); // Only Super Admins manage roles via API
    }

    // --- THE VAULT (Strict Isolation) ---

    // Match the deep path: /provinces/{p}/cities/{c}/barangays/{b}
    match /provinces/{province}/cities/{city}/barangays/{barangay} {
      
      // The Barangay Root Document (Read-Only metadata for the tenant admin, managed by API)
      allow read: if isTenantAdmin(province, city, barangay);
      allow write: if false; 

      // Match ANY document at ANY depth inside the barangay
      // Only Super Admins (covered by global rule) and Tenant Admins can write
      match /{document=**} {
        allow read, write: if isTenantAdmin(province, city, barangay);
      }
    }
  }
}
