
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- HELPER FUNCTIONS ---

    // Check if the user is a Super Admin
    function isSuperAdmin() {
      return request.auth.token.role == 'super_admin';
    }

    // Check if the user is a Tenant Admin for the specific path
    function isTenantAdmin(province, city, barangay) {
      let expectedPath = "provinces/" + province + "/cities/" + city + "/barangays/" + barangay;
      return request.auth.token.role == 'admin' && request.auth.token.tenantPath == expectedPath;
    }
    
    // Check if the user belongs to the tenant (regardless of role)
    function isTenantUser(province, city, barangay) {
      let expectedPath = "provinces/" + province + "/cities/" + city + "/barangays/" + barangay;
      return request.auth.token.tenantPath == expectedPath;
    }

    // --- GLOBAL RULES ---

    // 1. Super Admin: Unlimited Access
    match /{document=**} {
      allow read, write: if isSuperAdmin();
    }

    // 2. Tenant Directory
    match /tenant_directory/{tenantSlug} {
      allow read: if request.auth != null;
      allow write: if false; 
    }
    
    // 3. Global User Profiles
    match /users/{userId} {
        allow read, write: if request.auth != null;
    }

    // --- LEGACY / FLAT STRUCTURE SUPPORT (For Demo/Dev) ---
    match /barangays/{barangayId}/{document=**} {
        // Allow authenticated users to access this path for now
        // This is crucial for the Resident Dashboard demo connecting to 'barangay_san_isidro'
        allow read, write: if request.auth != null;
    }

    // --- THE VAULT (Strict Isolation) ---

    match /provinces/{province}/cities/{city}/barangays/{barangay} {
      
      // The Barangay Root Document 
      allow read: if isTenantUser(province, city, barangay); // Allow all tenant users to read the root config
      allow write: if false; 

      // Specific Collections with broader access
      
      // Emergency Alerts: Allow any tenant user (e.g. Responders) to read/write
      match /emergency_alerts/{alertId} {
        allow read, write: if isTenantUser(province, city, barangay);
      }

      // Responder Locations: Allow any tenant user to read/write
      match /responder_locations/{userId} {
        allow read, write: if isTenantUser(province, city, barangay);
      }

      // Default: Only Admins
      match /{document=**} {
        allow read, write: if isTenantAdmin(province, city, barangay);
      }
    }
  }
}
