rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // --- Helper Functions ---
    function isSuperAdmin() {
      return request.auth != null && request.auth.token.role == 'super_admin';
    }

    // --- Tenant Directory (Public Read for resolving paths, Write restricted) ---
    // Used by the client to look up "Where is bacoor-brgy-genesis located?"
    match /tenant_directory/{slug} {
      allow read: if true; 
      allow write: if isSuperAdmin(); // Allow Super Admins to manage directory via client if needed
    }
    
    // --- Global User Profiles (Optional, if used) ---
    match /users/{userId} {
      // Users can read/write their own profile. Super Admins can read/write all.
      allow read, write: if (request.auth != null && request.auth.uid == userId) || isSuperAdmin();
    }

    // --- Logical Vault Structure ---
    // The core of the multi-tenant architecture.
    // Deep Wildcard Match: Captures the hierarchy levels for Province, City, Barangay.
    match /provinces/{province}/cities/{city}/barangays/{barangay} {
      
      // Helper: Validates that the user's custom claim 'tenantPath' strictly matches this document's path.
      function isTenantMember() {
        return request.auth != null && 
               request.auth.token.tenantPath == /databases/$(database)/documents/provinces/$(province)/cities/$(city)/barangays/$(barangay);
      }

      // 1. Root Vault Document (e.g., .../barangays/brgy-genesis)
      allow read: if isTenantMember() || isSuperAdmin();
      allow write: if isSuperAdmin(); // Only Super Admin (or Admin SDK) writes the root metadata

      // 2. All Subcollections within the Vault (Settings, Residents, Assets, etc.)
      // {document=**} is a recursive wildcard.
      match /{document=**} {
        allow read, write: if isTenantMember() || isSuperAdmin();
      }
    }

    // --- Legacy / Global Collections (TEMPORARY: Keep for backward compatibility/demo) ---
    // Warning: These are insecure public endpoints. Remove when migration is complete.
    match /barangays/{barangayId}/fixed_assets/{document=**} { allow read, write: if true; }
    match /barangays/{barangayId}/asset_bookings/{document=**} { allow read, write: if true; }
    match /barangays/{barangayId}/emergency_alerts/{document=**} { allow read, write: if true; }
    match /barangays/{barangayId}/blotter_cases/{document=**} { allow read, write: if true; }
    match /barangays/{barangayId}/certificate_requests/{document=**} { allow read, write: if true; }
    match /barangays/{barangayId}/ordinances/{document=**} { allow read, write: if true; }
    
    // Default Fallback
    // Allow Super Admin to access any other collections (like 'system' or 'stats')
    match /{document=**} {
      allow read, write: if isSuperAdmin();
    }
  }
}
