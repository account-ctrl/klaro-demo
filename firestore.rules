rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // --- Helper Functions ---
    function isSuperAdmin() {
      return request.auth != null && request.auth.token.role == 'super_admin';
    }

    function isTenantMember(docTenantId) {
      return (request.auth.token.tenantId == docTenantId) || 
             (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.tenantId == docTenantId);
    }

    // --- DEBUG MODE: Global Read Access (TEMPORARY) ---
    // Warning: This exposes ALL data. Revert immediately after testing.
    match /{document=**} {
      allow read: if true; 
      allow write: if isSuperAdmin(); // Keep write restricted to avoid mess
    }

    // ... (Keep existing specific rules below if needed, but the global match above might shadow them depending on order/specificity logic in Firestore. 
    // In Firestore rules, overlapping match statements are allowed, and if ANY allow rule grants access, access is granted.
    // So adding the global read above ensures read is allowed.)

    // --- Tenant Directory ---
    match /tenant_directory/{slug} {
      allow read: if true; 
      allow write: if isSuperAdmin();
    }
    
    // --- Global User Profiles ---
    match /users/{userId} {
      allow read: if (request.auth != null && request.auth.uid == userId) || 
                     isSuperAdmin() || 
                     isTenantMember(resource.data.tenantId);
      
      allow write: if (request.auth != null && request.auth.uid == userId) || 
                      isSuperAdmin() || 
                      isTenantMember(resource.data.tenantId);
      
      allow create: if request.auth != null && 
                       (request.resource.data.tenantId == request.auth.token.tenantId || 
                        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.tenantId == request.resource.data.tenantId);
    }

    // --- Logical Vault Structure ---
    match /provinces/{province}/cities/{city}/barangays/{barangay} {
      
      function isVaultMember() {
        return request.auth != null && 
               request.auth.token.tenantPath == /databases/$(database)/documents/provinces/$(province)/cities/$(city)/barangays/$(barangay);
      }

      allow read: if isVaultMember() || isSuperAdmin();
      allow write: if isSuperAdmin() || isVaultMember();

      match /{document=**} {
        allow read, write: if isVaultMember() || isSuperAdmin();
      }
    }
  }
}
