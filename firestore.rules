
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- HELPER FUNCTIONS ---

    // Check if the user is a Super Admin
    function isSuperAdmin() {
      return request.auth.token.role == 'super_admin';
    }

    // Check if the user is a Tenant Admin for the specific path
    // CORRECTED: Compare against the relative path string, matching what provisioning.ts stores
    function isTenantAdmin(province, city, barangay) {
      let expectedPath = "provinces/" + province + "/cities/" + city + "/barangays/" + barangay;
      return request.auth.token.role == 'admin' && request.auth.token.tenantPath == expectedPath;
    }

    // --- GLOBAL RULES ---

    // 1. Super Admin: Unlimited Access
    match /{document=**} {
      allow read, write: if isSuperAdmin();
    }

    // 2. Tenant Directory: Public Read (for finding login paths), No Write
    match /tenant_directory/{tenantSlug} {
      allow read: if request.auth != null;
      allow write: if false; // Only Admin SDK can write
    }
    
    // 3. Global User Profiles: Users can read their own profile
    match /users/{userId} {
        allow read: if request.auth != null && (request.auth.uid == userId || isSuperAdmin());
        allow write: if isSuperAdmin(); // Only Super Admins manage roles via API
    }

    // --- THE VAULT (Strict Isolation) ---

    // Match the deep path: /provinces/{p}/cities/{c}/barangays/{b}
    match /provinces/{province}/cities/{city}/barangays/{barangay} {
      
      // The Barangay Root Document (Read-Only metadata for the tenant admin, managed by API)
      allow read: if isTenantAdmin(province, city, barangay);
      allow write: if false; 

      // Match ANY document at ANY depth inside the barangay
      // Only Super Admins (covered by global rule) and Tenant Admins can write
      match /{document=**} {
        allow read, write: if isTenantAdmin(province, city, barangay);
      }
    }
  }
}
