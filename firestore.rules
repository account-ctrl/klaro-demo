rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // --- Helper Functions ---
    function isSuperAdmin() {
      return request.auth != null && request.auth.token.role == 'super_admin';
    }

    function isTenantMember(docTenantId) {
      // 1. Check Custom Claim (Fastest, Free)
      // 2. Fallback: Check User Profile in DB (1 Read cost, handles stale tokens)
      return (request.auth.token.tenantId == docTenantId) || 
             (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.tenantId == docTenantId);
    }

    // --- Tenant Directory ---
    match /tenant_directory/{slug} {
      allow read: if true; 
      allow write: if isSuperAdmin();
    }
    
    // --- Global User Profiles ---
    match /users/{userId} {
      // Allow read if:
      // 1. Own Profile
      // 2. Super Admin
      // 3. Same Tenant (Co-worker)
      allow read: if (request.auth != null && request.auth.uid == userId) || 
                     isSuperAdmin() || 
                     isTenantMember(resource.data.tenantId);
      
      // Allow write if:
      // 1. Own Profile (limited fields?) - usually specific fields only
      // 2. Super Admin
      // 3. Same Tenant (e.g. Captain editing Staff)
      allow write: if (request.auth != null && request.auth.uid == userId) || 
                      isSuperAdmin() || 
                      isTenantMember(resource.data.tenantId);
      
      // Allow create if assigning to own tenant
      allow create: if request.auth != null && 
                       (request.resource.data.tenantId == request.auth.token.tenantId || 
                        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.tenantId == request.resource.data.tenantId);
    }

    // --- Logical Vault Structure ---
    match /provinces/{province}/cities/{city}/barangays/{barangay} {
      
      function isVaultMember() {
        return request.auth != null && 
               request.auth.token.tenantPath == /databases/$(database)/documents/provinces/$(province)/cities/$(city)/barangays/$(barangay);
      }

      // Root access (e.g., /settings/general)
      // Captains need write access here to update Puroks and Configs
      allow read: if isVaultMember() || isSuperAdmin();
      allow write: if isSuperAdmin() || isVaultMember(); // "Dual-Key" Access Logic

      // Recursive Subcollection Access
      match /{document=**} {
        allow read, write: if isVaultMember() || isSuperAdmin();
      }
    }

    // --- Default Fallback ---
    match /{document=**} {
      allow read, write: if isSuperAdmin();
    }
  }
}
