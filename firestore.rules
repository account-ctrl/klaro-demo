rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- HELPER FUNCTIONS ---

    // Check if the user is a Super Admin
    function isSuperAdmin() {
      return request.auth.token.role == 'super_admin';
    }

    // Check if the user is a Tenant Admin for the specific path
    function isTenantAdmin(province, city, barangay) {
      let expectedPath = "provinces/" + province + "/cities/" + city + "/barangays/" + barangay;
      return request.auth.token.role == 'admin' && request.auth.token.tenantPath == expectedPath;
    }
    
    // Check if the user belongs to the tenant (regardless of role - admin, staff, or resident)
    function isTenantUser(province, city, barangay) {
      let expectedPath = "provinces/" + province + "/cities/" + city + "/barangays/" + barangay;
      return request.auth.token.tenantPath == expectedPath;
    }

    // Check if the request is from the authenticated user themselves
    function isOwner(userId) {
        return request.auth.uid == userId;
    }

    // --- GLOBAL RULES ---

    // 1. Super Admin: Unlimited Access
    match /{document=**} {
      allow read, write: if isSuperAdmin();
    }

    // 2. Tenant Directory (Public Read for Tenant Selection)
    match /tenant_directory/{tenantSlug} {
      allow read: if true; 
      allow write: if false; 
    }
    
    // 3. Global User Profiles (The connection point)
    match /users/{userId} {
        allow read: if isOwner(userId) || request.auth.token.role == 'admin' || request.auth.token.role == 'super_admin';
        allow write: if isOwner(userId) || request.auth.token.role == 'admin' || request.auth.token.role == 'super_admin';
    }

    // --- THE VAULT (Strict Isolation) ---

    match /provinces/{province}/cities/{city}/barangays/{barangay} {
      
      allow read: if isTenantUser(province, city, barangay); 
      allow write: if false; 

      // --- RESIDENT RECORDS (The Source of Truth) ---
      match /resident_records/{residentId} {
         allow read, write: if isTenantAdmin(province, city, barangay);
         allow read: if resource.data.linkedUserId == request.auth.uid;
      }

      // --- DOCUMENTS (Strict Isolation) ---
      match /users/{userId}/documents/{documentId} {
         allow read, write: if isOwner(userId);
         allow read, write: if isTenantAdmin(province, city, barangay);
      }

      // Emergency Alerts
      match /emergency_alerts/{alertId} {
        allow read, write: if isTenantUser(province, city, barangay);
      }

      // Responder Locations
      match /responder_locations/{userId} {
        allow read, write: if isTenantUser(province, city, barangay);
      }

      // --- FINANCIAL MODULE ---
      function isTreasurer() {
         return isTenantAdmin(province, city, barangay); 
      }

      // 1. Appropriations & Allotments (Budget)
      match /appropriations/{docId} {
        allow read: if request.auth != null; 
        allow write: if isTreasurer();
      }
      match /allotments/{docId} {
        allow read: if request.auth != null; 
        allow write: if isTreasurer(); 
      }
      
      // 1.5 Budget Proposals (Drafts)
      match /budget_proposals/{docId} {
        allow read: if request.auth != null; 
        allow write: if isTenantUser(province, city, barangay);
      }

      // 2. Obligations
      match /obligations/{docId} {
        allow read: if isTenantUser(province, city, barangay);
        allow create: if isTreasurer() && request.resource.data.createdBy == request.auth.uid;
        allow update: if isTreasurer() && request.resource.data.amount == resource.data.amount; 
      }

      // 3. Transactions
      match /obligations/{obligationId}/transactions/{txId} {
        allow read: if isTenantUser(province, city, barangay);
        allow create: if isTreasurer();
        allow update, delete: if false; 
      }
      
      // 4. Procurement (New)
      match /vendors/{docId} {
        allow read: if request.auth != null;
        allow write: if isTenantUser(province, city, barangay);
      }
      match /catalog_items/{docId} {
        allow read: if request.auth != null;
        allow write: if isTenantUser(province, city, barangay);
      }
      match /purchase_orders/{docId} {
        allow read: if request.auth != null;
        allow write: if isTenantUser(province, city, barangay);
      }

      // Default: Only Admins
      match /{document=**} {
        allow read, write: if isTenantAdmin(province, city, barangay);
      }
    }
  }
}
